<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japanese SRT Vocabulary Extractor</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .upload-form {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            text-align: center;
        }
        .deck-list {
            margin-top: 40px;
        }
        .deck-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .success { background: #e6ffe6; }
        .error { background: #ffe6e6; }
    </style>
</head>
<body>
    <h1>Japanese SRT Vocabulary Extractor</h1>

    <div class="tab-container">
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('srt')">SRT Upload</button>
            <button class="tab-btn" onclick="showTab('csv')">CSV Upload</button>
        </div>

        <div id="srt-tab" class="tab-content active">
            <div class="upload-form">
                <form id="srtForm" enctype="multipart/form-data">
                    <input type="file" name="file" accept=".srt" required>
                    <select name="format" required>
                        <option value="anki">Anki Deck</option>
                        <option value="latex">LaTeX</option>
                    </select>
                    <label>
                        <input type="checkbox" name="include_audio" value="1">
                        Include TTS Audio
                    </label>
                    <button type="submit">Generate Deck</button>
                </form>
            </div>
        </div>

        <div id="csv-tab" class="tab-content">
            <div class="upload-form">
                <form id="csvForm" enctype="multipart/form-data">
                    <input type="file" name="file" accept=".csv,.txt" required onchange="analyzeCSV(this)">
                    <div id="csv-preview" style="display: none;">
                        <h3>CSV Preview</h3>
                        <div id="preview-content"></div>
                    </div>
                    <div class="field-mapping">
                        <h3>Field Mapping</h3>
                        <div class="field-row">
                            <label>Term Field:</label>
                            <select name="term_field"></select>
                        </div>
                        <div class="field-row">
                            <label>Reading Field:</label>
                            <select name="reading_field"></select>
                        </div>
                        <div class="field-row">
                            <label>Meaning Field:</label>
                            <select name="meaning_field"></select>
                        </div>
                        <div class="field-row">
                            <label>Context (JP):</label>
                            <select name="context_jp_field">
                                <option value="">None</option>
                            </select>
                        </div>
                        <div class="field-row">
                            <label>Context (EN):</label>
                            <select name="context_en_field">
                                <option value="">None</option>
                            </select>
                        </div>
                        <div class="field-row">
                            <label>Level:</label>
                            <select name="level_field">
                                <option value="">None</option>
                            </select>
                        </div>
                        <div class="field-row">
                            <label>Separator:</label>
                            <input type="text" name="separator" value="," required>
                        </div>
                    </div>
                    <select name="format" required>
                        <option value="anki">Anki Deck</option>
                        <option value="latex">LaTeX</option>
                    </select>
                    <button type="submit">Generate Deck</button>
                </form>
            </div>
        </div>
    </div>

    <div id="status" class="status"></div>

    <div id="progress" class="progress" style="display: none;">
        <div class="progress-bar"></div>
        <div class="progress-text"></div>
    </div>

    <style>
        /* Additional styles for the new UI */
        .tab-container {
            margin: 20px 0;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #eee;
            cursor: pointer;
            border-radius: 4px;
        }
        .tab-btn.active {
            background: #007bff;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .field-mapping {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .field-row {
            display: flex;
            align-items: center;
            margin: 10px 0;
            gap: 10px;
        }
        .field-row label {
            width: 120px;
            text-align: right;
        }
        .field-row input, .field-row select {
            flex: 1;
            max-width: 200px;
            padding: 5px;
        }
        .preview-table {
            width: 100%;
            margin: 15px 0;
            border-collapse: collapse;
            font-size: 14px;
        }
        .preview-table th, .preview-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .preview-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .preview-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
    </style>

    <script>
        async function analyzeCSV(fileInput) {
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/csv/analyze', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.error) {
                    throw new Error(result.error);
                }

                // Show preview
                const previewDiv = document.getElementById('csv-preview');
                const previewContent = document.getElementById('preview-content');
                previewDiv.style.display = 'block';

                // Create preview table
                const table = document.createElement('table');
                table.className = 'preview-table';

                // Add headers
                const headerRow = document.createElement('tr');
                result.headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                table.appendChild(headerRow);

                // Add preview rows
                result.preview_rows.forEach(row => {
                    const tr = document.createElement('tr');
                    row.forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    table.appendChild(tr);
                });

                previewContent.innerHTML = '';
                previewContent.appendChild(table);

                // Update all select dropdowns with headers
                const selects = document.querySelectorAll('.field-mapping select');
                selects.forEach(select => {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">None</option>';
                    result.headers.forEach(header => {
                        const option = document.createElement('option');
                        option.value = header;
                        option.textContent = header;
                        select.appendChild(option);
                    });
                });

                // Apply LLM suggestions if available
                if (result.suggestions?.suggested_mapping) {
                    const mapping = result.suggestions.suggested_mapping;
                    document.querySelector('[name="term_field"]').value = mapping.term_field;
                    document.querySelector('[name="reading_field"]').value = mapping.reading_field;
                    document.querySelector('[name="meaning_field"]').value = mapping.meaning_field;
                    document.querySelector('[name="context_jp_field"]').value = mapping.context_jp_field || '';
                    document.querySelector('[name="context_en_field"]').value = mapping.context_en_field || '';
                    document.querySelector('[name="level_field"]').value = mapping.level_field || '';
                }

                // Update separator
                document.querySelector('[name="separator"]').value = result.separator;

            } catch (error) {
                console.error('Error analyzing CSV:', error);
                const status = document.getElementById('status');
                status.className = 'status error';
                status.textContent = `Error analyzing CSV: ${error.message}`;
                status.style.display = 'block';
            }
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
        }

        async function handleSubmit(e, endpoint) {
            e.preventDefault();
            const progress = document.getElementById('progress');
            const progressBar = document.querySelector('.progress-bar');
            const progressText = document.querySelector('.progress-text');
            const formData = new FormData(e.target);

            try {
                progress.style.display = 'block';
                progressBar.style.width = '0%';
                progressText.textContent = 'Starting...';

                const response = await fetch(`/upload/${endpoint}`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Upload failed');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const {value, done} = await reader.read();
                    if (done) break;

                    const events = decoder.decode(value).split('\n\n');
                    for (const event of events) {
                        if (event.startsWith('data: ')) {
                            const data = JSON.parse(event.slice(6));
                            progressText.textContent = data.message;

                            if (data.progress !== null) {
                                progressBar.style.width = `${data.progress}%`;
                            }

                            if (data.stage === 'complete' && data.filename) {
                                // Create hidden download link and click it
                                const link = document.createElement('a');
                                link.href = `/download/${data.filename}`;
                                link.download = data.filename;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                progressText.textContent = 'Download complete!';
                            } else if (data.stage === 'error') {
                                progressBar.style.backgroundColor = '#dc3545';
                                progressText.textContent = `Error: ${data.message}`;
                                progress.style.display = 'block';  // Ensure error is visible
                            }
                        }
                    }
                }

            } catch (error) {
                progressText.textContent = `Error: ${error.message}`;
                progressBar.style.backgroundColor = '#dc3545';
            }
        }

        document.getElementById('srtForm').onsubmit = (e) => handleSubmit(e, 'srt');
        document.getElementById('csvForm').onsubmit = (e) => handleSubmit(e, 'csv');
    </script>
</body>
</html>
